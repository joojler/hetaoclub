<?php TPL::output('admin/global/header.tpl.htm'); ?>
<?php TPL::output('admin/global/nav_menu.tpl.htm'); ?>

<div class="pull-left right-side">
	<div class="alert alert-success hide error-message"></div>
	<div class="aw-mod-body">
		<!-- 最新问题 -->
		<script type="text/x-template" id="drop_menu_template_new_question">
			<div class="dropdown-menu pull-right<?php if ($this->category_data) { ?> subtract-two<?php } ?>">
				<div class="mod-head clearfix">
					<?php if ($this->category_data) { ?>
					<div class="mod">
						<div class="mod-head"><?php _e('分类最新问题'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_NEW_QUESTION"><a><?php _e('全部最新问题'); ?></a></li>
								<?php foreach ($this->category_data AS $val) { ?>
							    <li data-value="COMMAND_NEW_QUESTION__CATEGORY_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							    <?php } ?>
							</ul>  
						</div>
					</div>
					<?php } ?>
					
					<div class="mod">
						<div class="mod-head"><?php _e('专题最新问题'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_NEW_QUESTION"><a><?php _e('全部最新问题'); ?></a></li>
								<?php if ($this->feature_list) { ?>
								<?php foreach ($this->feature_list AS $val) { ?>
							    <li data-value="COMMAND_NEW_QUESTION__FEATURE_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							    <?php } ?>
							    <?php } ?>
							</ul>
						</div>
					</div>	
				</div>
			</div>
		</script>
		<!-- end 最新问题 -->

		<!-- 文章专题 -->
		<script type="text/x-template" id="drop_menu_template_new_article">
			<div class="dropdown-menu pull-right">
				<div class="mod-head clearfix">
					<div class="mod">
						<div class="mod-head"><?php _e('文章专题'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_NEW_ARTICLE"><a><?php _e('全部文章'); ?></a></li>
								<?php if ($this->feature_list) { ?>
								<?php foreach ($this->feature_list AS $val) { ?>
							    <li data-value="COMMAND_NEW_ARTICLE__FEATURE_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							    <?php } ?>
							    <?php } ?>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</script>
		<!-- end 文章专题 -->

		<!-- 热门问题 -->
		<script type="text/x-template" id="drop_menu_template_hot_question">
			<div class="dropdown-menu pull-right<?php if ($this->category_data) { ?> subtract-two<?php } ?>">
				<div class="mod-head clearfix">
					<?php if ($this->category_data) { ?>
					<div class="mod">
						<div class="mod-head"><?php _e('分类热门问题'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_HOT_QUESTION"><a><?php _e('全部热门问题'); ?></a></li>
								<?php foreach ($this->category_data AS $val) { ?>
					    		<li data-value="COMMAND_HOT_QUESTION__CATEGORY_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
								<?php } ?>
							</ul>	
						</div>
					</div>
					<?php } ?>
					

					<div class="mod">
						<div class="mod-head"><?php _e('专题热门问题'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_HOT_QUESTION"><a><?php _e('全部热门问题'); ?></a></li>
								<?php if ($this->feature_list) { ?>
								<?php foreach ($this->feature_list AS $val) { ?>
							    <li data-value="COMMAND_HOT_QUESTION__FEATURE_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							    <?php } ?>
							    <?php } ?>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</script>
		<!-- end热门问题 -->

		<!-- 推荐问题 -->
		<script type="text/x-template" id="drop_menu_template_suggest_question">
			<div class="dropdown-menu pull-right">
				<?php if ($this->category_data) { ?>
				<div class="mod">
					<div class="mod-head"><?php _e('分类推荐问题'); ?></div>
					<div class="divider"></div>
					<div class="mod-footer">
						<ul class="control-height">
							<li data-value="COMMAND_RECOMMEND_QUESTION"><a><?php _e('全部推荐问题'); ?></a></li>
							<?php foreach ($this->category_data AS $val) { ?>
				    		<li data-value="COMMAND_RECOMMEND_QUESTION__CATEGORY_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							<?php } ?>
						</ul>	
					</div>
				</div>
				<?php } ?>
				
				<div class="mod">
					<div class="mod-head"><?php _e('专题推荐问题'); ?></div>
					<div class="divider"></div>
					<div class="mod-footer">
						<ul class="control-height">
							<li data-value="COMMAND_RECOMMEND_QUESTION"><a><?php _e('全部推荐问题'); ?></a></li>
							<?php if ($this->feature_list) { ?>
							<?php foreach ($this->feature_list AS $val) { ?>
						    <li data-value="COMMAND_RECOMMEND_QUESTION__FEATURE_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
						    <?php } ?>
						    <?php } ?>
						</ul>
					</div>
				</div>	
			</div>
		</script>
		<!-- end 推荐问题 -->

		<!-- 等待回复 -->
		<script type="text/x-template" id="drop_menu_template_wait_replay">
			<div class="dropdown-menu pull-right<?php if ($this->category_data) { ?> subtract-two<?php } ?>">
				<div class="mod-head clearfix">
				<?php if ($this->category_data) { ?>
				<div class="mod">
					<div class="mod-head"><?php _e('分类待回复问题'); ?></div>
					<div class="divider"></div>
					<div class="mod-footer">
						<ul class="control-height">
							<li data-value="COMMAND_NO_ANSWER_QUESTION"><a><?php _e('全部待回复问题'); ?></a></li>
							<?php foreach ($this->category_data AS $val) { ?>
				    		<li data-value="COMMAND_NO_ANSWER_QUESTION__CATEGORY_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
							<?php } ?>
						</ul>	
					</div>
				</div>
				<?php } ?>
				
				<div class="mod">
					<div class="mod-head"><?php _e('专题待回复问题'); ?></div>
					<div class="divider"></div>
					<div class="mod-footer">
						<ul class="control-height">
							<li data-value="COMMAND_NO_ANSWER_QUESTION"><a><?php _e('全部待回复问题'); ?></a></li>
							<?php if ($this->feature_list) { ?>
							<?php foreach ($this->feature_list AS $val) { ?>
						    <li data-value="COMMAND_NO_ANSWER_QUESTION__FEATURE_<?php echo $val['id']; ?>"><a><?php echo $val['title']; ?></a></li>
						    <?php } ?>
						    <?php } ?>
						</ul>
					</div>
				</div>	
				</div>
			</div>
		</script>
		<!-- end 等待回复 -->

		<!-- 自定义回复 -->
		<script type="text/x-template" id="drop_menu_template_auto_replay">
			<div class="dropdown-menu pull-right">
				<div class="mod-head clearfix">
					<div class="mod">
						<div class="mod-head"><?php _e('自定义回复'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<?php if ($this->reply_rule_list) { ?>
								<?php foreach ($this->reply_rule_list AS $val) { ?>
							    <li data-value="REPLY_RULE_<?php echo $val['id']; ?>" data-upload="false"><a><?php echo $val['keyword']; ?></a></li>
							    <?php } ?>
							    <?php } ?>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</script>
		<!-- end 自定义回复 -->

		<!-- 全局命令 -->
		<script type="text/x-template" id="drop_menu_template_global">
			<div class="dropdown-menu pull-right">
				<div class="mod-head clearfix">					
					<div class="mod">
						<div class="mod-head"><?php _e('全局命令'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="COMMAND_HOME_ACTIONS" data-upload="false"><a><?php _e('最新动态'); ?></a></li>
								<li data-value="COMMAND_NOTIFICATIONS" data-upload="false"><a><?php _e('最新通知'); ?></a></li>
								<li data-value="COMMAND_MY_QUESTION" data-upload="false"><a><?php _e('我的提问'); ?></a></li>
								<li data-value="COMMAND_MORE" data-upload="false"><a><?php _e('载入更多'); ?></a></li>
							</ul>
						</div>
					</div>	
				</div>
			</div>
		</script>
		<!-- end 全局命令 -->

		<!-- 自定义url -->
		<script type="text/x-template" id="drop_menu_template_defined_url">
			<div class="dropdown-menu pull-right">
				<div class="mod-head clearfix">					
					<div class="mod">
						<div class="mod-head"><?php _e('常用功能'); ?></div>
						<div class="divider"></div>
						<div class="mod-footer">
							<ul class="control-height">
								<li data-value="<?php echo get_js_url('/m/nearby_people/'); ?>" data-upload="false"><a><?php _e('附近的人'); ?></a></li>
								<li data-value="<?php echo get_js_url('/m/nearby_question/'); ?>" data-upload="false"><a><?php _e('附近的问题'); ?></a></li>
							</ul>
						</div>
					</div>	
				</div>
			</div>
		</script>
		<!-- end 自定义url -->

		<script type="text/x-template" id="select_option">
			<option></option>
			<option data-name="全局命令"><?php _e('全局命令'); ?></option>
			<option data-value="COMMAND_NEW_QUESTION" data-name="最新问题"><?php _e('最新问题'); ?></option>
		    <option data-value="COMMAND_NEW_ARTICLE" data-name="文章专题"><?php _e('文章专题'); ?></option>
		    <option data-value="COMMAND_HOT_QUESTION" data-name="热门问题"><?php _e('热门问题'); ?></option>
		    <option data-value="COMMAND_RECOMMEND_QUESTION" data-name="推荐问题"><?php _e('推荐问题'); ?></option>
		    <option data-value="COMMAND_HOME_ACTIONS" data-name="等待回复"><?php _e('等待回复'); ?></option>
		    <option data-name="自定义回复"><?php _e('自定义回复'); ?></option>
		    <option data-name="自定义 URL"><?php _e('自定义 URL'); ?></option>
		</script>
		
		<script type="text/x-template" id="top_menu_template">
			<tr data-id="{MENU_ID}" class="top_menu" id="menu_id_{MENU_ID}">
				<td><input class="form-control input-xlarge" type="text" value="" name="button[{MENU_ID}][name]" /></td>
				<td align="center"><input type="text" value="" class="form-control sort-action" name="button[{MENU_ID}][sort]" /></td>
				<td aligin="center">
					<select class="aw-wechat-select" name="button[{MENU_ID}][command_type]">
					</select>
				</td>
				<td align="center">
					<div class="aw-wechat-dropdown-box">
						<span>&nbsp;</span>
						<input type="button" value="" class="input-bg"  data-toggle="dropdown" />
						<input class="form-control input-code hide" readonly="readonly" type="text" name="button[{MENU_ID}][key]" placeholder="<?php _e('点击右侧按钮选择命令'); ?>" />
						<a class="fa fa-sort" data-toggle="dropdown"></a>
						
						<input type="hidden" class="attach_key" name="button[{MENU_ID}][attach_key]" value="" />
						<a class="ajax-upload"><i class="fa fa-upload"></i></a>
						<a class="ajax-look" onclick="if ($(this).parent().find('input.attach_key').val() != '') { $.dialog('imagePreview', {'image':'<?php echo get_setting('upload_url'); ?>/weixin/list_image/' + $(this).parent().find('input.attach_key').val() + '.jpg?'+ Math.random() }) } else { alert('<?php _e('当前菜单没有上传图片'); ?>'); }"><i class="fa fa-picture-o"></i></a>
					</div>
				</td>
				<td align="center">
					<a href="javascript:;" onclick="if ($('#mp_menu_table tbody tr.sub_button_{MENU_ID}').length > 4) { alert('<?php _e('最多只能创建 5 个子菜单'); ?>') } else { $('tr#menu_id_{MENU_ID}').after($('#sub_button_template').html().replace(/{MENU_TOP_ID}/g, '{MENU_ID}').replace(/{MENU_SUB_ID}/g, hex_md5(new Date().getTime() + '|' + Math.random()))); ajax_upload_reload();$('tr#menu_id_{MENU_ID}').next().find('.aw-wechat-select').append($('#select_option').html()); }"><?php _e('添加子菜单'); ?></a> | 
					<a href="javascript:;" onclick="$(this).parents('tr').remove(); $('.sub_button_{MENU_ID}').remove();"><?php _e('删除'); ?></a>
				</td>
			</tr>
		</script>
		
		<script type="text/x-template" id="sub_button_template">
			<tr class="sub_button_{MENU_TOP_ID}" data-id="{MENU_SUB_ID}">
				<td> -- <input class="form-control input-xlarge inline-block" type="text" value="" name="button[{MENU_TOP_ID}][sub_button][{MENU_SUB_ID}][name]" /></td>
				<td align="center"><input type="text" value="" class="form-control sort-action" name="button[{MENU_TOP_ID}][sub_button][{MENU_SUB_ID}][sort]" /></td>
				<td aligin="center">
					<select class="aw-wechat-select" name="button[{MENU_TOP_ID}][sub_button][{MENU_SUB_ID}][command_type]">
					</select>
				</td>
				<td align="center">
					<div class="aw-wechat-dropdown-box">
						<span>&nbsp;</span>
						<input type="button" value="" class="input-bg"  data-toggle="dropdown" />
						<input class="form-control input-code hide" readonly="readonly" type="text" name="button[{MENU_TOP_ID}][sub_button][{MENU_SUB_ID}][key]" placeholder="点击右侧按钮选择命令" />
						<a class="fa fa-sort" data-toggle="dropdown"></a>
						
						<input type="hidden" class="attach_key" name="button[{MENU_TOP_ID}][sub_button][{MENU_SUB_ID}][attach_key]" value="" />
						<a class="ajax-upload hide"><i class="fa fa-upload"></i></a>
						<a class="ajax-look hide" onclick="if ($(this).parent().find('input.attach_key').val() != '') { $.dialog('imagePreview', {'image':'<?php echo get_setting('upload_url'); ?>/weixin/list_image/' + $(this).parent().find('input.attach_key').val() + '.jpg?'+ Math.random()}) } else { alert('<?php _e('当前菜单没有上传图片'); ?>'); }"><i class="fa fa-picture-o"></i></a>
					</div>
				</td>
				<td align="center">
					<a href="javascript:;" onclick="$(this).parents('tr').remove();"><?php _e('删除'); ?></a>
				</td>
			</tr>
		</script>
		
		<form id="mp_menu_form" action="admin/weixin/save_mp_menu/" method="post">
		<table class="aw-table" id="mp_menu_table">
			<thead>
				<tr>
					<th style="width:25%;"><?php _e('菜单标题'); ?></th>
					<th align="center" style="width:15%"><?php _e('排序'); ?></th>
					<th align="center" style="width:10%"><?php _e('菜单选择'); ?></th>
					<th align="center" style="width:15%;"><?php _e('菜单命令'); ?></th>
					<th align="center" style="width:20%;"><?php _e('操作'); ?></th>
				</tr>
			</thead>
			<tbody>
				<?php foreach ($this->mp_menu AS $key => $val) { ?>
					<tr data-id="<?php echo $key; ?>" class="top_menu" id="menu_id_<?php echo $key; ?>">
						<td><input type="text" class="input-xlarge" value="<?php echo $val['name']; ?>" name="button[<?php echo $key; ?>][name]" /></td>
						<td align="center"><input type="text" value="<?php echo $val['sort']; ?>" class="form-control sort-action" name="button[<?php echo $key; ?>][sort]" /></td>
						<td aligin="center">
							<select class="aw-wechat-select" name="button[<?php echo $key?>][command_type]">
							</select>
						</td>
						<td align="center">
							<div class="aw-wechat-dropdown-box">
								<span>&nbsp;</span>
								<input type="button" value="" class="input-bg"  data-toggle="dropdown" />
								<input class="form-control input-code hide" readonly="readonly" type="text" name="button[<?php echo $key; ?>][key]" value="<?php echo $val['key']; ?>" placeholder="点击右侧按钮选择命令" />
								<a class="fa fa-sort" data-toggle="dropdown"></a>
								<input type="hidden" class="attach_key" name="button[<?php echo $key; ?>][attach_key]" value="<?php echo $val['attach_key']; ?>" />
								<a class="ajax-upload"><i class="fa fa-upload"></i></a>
								<a class="ajax-look" onclick="if ($(this).parent().find('input.attach_key').val() != '') { $.dialog('imagePreview', {'image':'<?php echo get_setting('upload_url'); ?>/weixin/list_image/' + $(this).parent().find('input.attach_key').val() + '.jpg?'+ Math.random()}) } else { alert('<?php _e('当前菜单没有上传图片'); ?>'); }"><i class="fa fa-picture-o"></i></a>
							</div>

						</td>
						<td align="center">
							<a href="javascript:;" onclick="if ($('#mp_menu_table tbody tr.sub_button_<?php echo $key; ?>').length > 4) { alert('<?php _e('最多只能创建 5 个子菜单'); ?>') } else { $('tr#menu_id_<?php echo $key; ?>').after($('#sub_button_template').html().replace(/{MENU_TOP_ID}/g, '<?php echo $key; ?>').replace(/{MENU_SUB_ID}/g, hex_md5(new Date().getTime() + ' ' + Math.random()))); ajax_upload_reload();$('tr#menu_id_<?php echo $key; ?>').next().find('.aw-wechat-select').append($('#select_option').html()); }"><?php _e('添加子菜单'); ?></a> | 
							<a href="javascript:;" onclick="$(this).parents('tr').remove(); $('.sub_button_<?php echo $key; ?>').remove();"><?php _e('删除'); ?></a>
						</td>
					</tr>
					<?php if ($val['sub_button']) { ?>
						<?php foreach ($val['sub_button'] AS $sub_key => $sub_val) { ?>				
						<tr class="sub_button_<?php echo $key; ?>" data-id="<?php echo $sub_key; ?>">
							<td> -- <input class="form-control input-xlarge inline-block" type="text" value="<?php echo $sub_val['name']; ?>" name="button[<?php echo $key; ?>][sub_button][<?php echo $sub_key; ?>][name]" /></td>
							<td align="center"><input type="text" value="<?php echo $sub_val['sort']; ?>" class="form-control sort-action" name="button[<?php echo $key; ?>][sub_button][<?php echo $sub_key; ?>][sort]" /></td>
							<td align="center">
								<select class="aw-wechat-select" name="button[<?php echo $key; ?>][sub_button][<?php echo $sub_key; ?>][command_type]">
								</select>
							</td>
							<td align="center">
								<div class="aw-wechat-dropdown-box">
									<span>&nbsp;</span>
									<input type="button" value="" class="input-bg"  data-toggle="dropdown" />
									<input class="form-control input-code hide" readonly="readonly" type="text" name="button[<?php echo $key; ?>][sub_button][<?php echo $sub_key; ?>][key]" value="<?php echo $sub_val['key']; ?>" placeholder="点击右侧按钮选择命令" />
									<a class="fa fa-sort" data-toggle="dropdown"></a>
									
									<input type="hidden" class="attach_key" name="button[<?php echo $key; ?>][sub_button][<?php echo $sub_key; ?>][attach_key]" value="<?php echo $sub_val['attach_key']; ?>" />
									<a class="ajax-upload"><i class="fa fa-upload"></i></a>
									<a class="ajax-look" onclick="if ($(this).parent().find('input.attach_key').val() != '') { $.dialog('imagePreview', {'image':'<?php echo get_setting('upload_url'); ?>/weixin/list_image/' + $(this).parent().find('input.attach_key').val() + '.jpg?'+ Math.random()}) } else { alert('<?php _e('当前菜单没有上传图片'); ?>'); }"><i class="fa fa-picture-o"></i></a>
								</div>
							</td>
							<td align="center">
								<a href="javascript:;" onclick="$(this).parents('tr').remove();"><?php _e('删除'); ?></a>
							</td>
						</tr>
						<?php } ?>
					<?php } ?>
				<?php } ?>
			</tbody>
			<tfoot>
				<tr>
					<td colspan="5">
						<a class="btn btn-inverse inline-block pull-right" href="javascript:;" onclick="$('#form_update_weixin_menu').submit();"><?php _e('提交菜单至微信'); ?></a>
						
						<a class="btn btn-inverse inline-block" href="javascript:;" onclick="if ($('#mp_menu_table tbody tr.top_menu').length > 2) { alert('<?php _e('最多只能创建 3 个菜单'); ?>') } else { $('#mp_menu_table tbody').append($('#top_menu_template').html().replace(/{MENU_ID}/g, hex_md5(new Date().getTime() + '|' + Math.random())));$('#mp_menu_table tbody tr:last').find('.aw-wechat-select').append($('#select_option').html()); }"><?php _e('添加菜单'); ?></a>
						
						<a class="btn btn-inverse inline-block" href="javascript:;" onclick="ajax_post($('#mp_menu_form'));"><?php _e('保存设置'); ?></a>
					</td>
				</tr>
			</tfoot>
		</table>
		</form>
		<form action="admin/tools/init/" id="form_update_weixin_menu" method="post" target="_blank">
			<input type="hidden" name="action" value="update_weixin_menu" />
		</form>
	</div>
</div>

<script type="text/javascript">
	var mp_menu_list = eval('[<?php echo json_encode($this->mp_menu); ?>]');
	
	$(function()
	{
		// 初始化上传按钮
		ajax_upload_reload();

		// 遍历给ajaxbox插入模板
		$.each($("script[type='text/x-template']"), function (i, e) {
			$('#aw-ajax-box').append($(e).html());
		});

		//动态插入select内的option
		$('#mp_menu_table tr').find('.aw-wechat-select').append($('#select_option').html());
		
		//select初始化
		$.each(mp_menu_list, function(i, e)
		{
			$.each(e, function(i, e)
			{
				var _i = i, _e = e, sub_command_type = [];
				// 判断是否有子菜单
				if (e.sub_button)
				{
					// arr_code span内容数组, arr_select select内容
					var arr_code = [], arr_select = [];
					// 遍历初始化子菜单
					$.each(e.sub_button, function(i, e)
					{
						var _e = e;
						arr_select.push(e.command_type);
						// 判断如果是自定义url给arr_code插入空数组
						if (_e.key.match('http'))
						{
							arr_code.push('');
						}
						else
						{
							// 遍历模板中li,找到相应的中文内容插入到arr_code内
							$.each($('#aw-ajax-box ul li'), function (i, e)
							{
								if ($(this).attr('data-value') == _e.key)
								{
									arr_code.push($(this).text());
								}
							});
						}


					});
				
					// 遍历select菜单数组,设置select菜单默认值,动态插入下拉菜单
					$.each(arr_select, function (i, e)
					{
						//插入菜单
						addDropdownList(e, $('.sub_button_' + _i).eq(i), false);

						if (e == '自定义 URL')
						{
							$('.sub_button_' + _i).eq(i).find('input.input-bg, span').hide();
							$('.sub_button_' + _i).eq(i).find('.input-code').removeAttr('readonly').show();
							$('.sub_button_' + _i).eq(i).find('.aw-wechat-select').val(e);
						}
						else
						{
							$('.sub_button_' + _i).eq(i).find('.aw-wechat-select').val(e);
						}
					});

					// 遍历arr_code数组,设置span默认值
					$.each(arr_code, function (i, e)
					{
						$('.sub_button_' + _i).eq(i).find('.aw-wechat-dropdown-box span').html(e);
						$.each($('.sub_button_' + _i).eq(i).find('.aw-wechat-dropdown-box ul li'), function (i, e)
						{

							if ($(this).attr('data-value') == $(this).parents('.aw-wechat-dropdown-box').find('input.input-code').val())
							{
								if ($(this).attr('data-value').match('http://'))
								{
									$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look ').hide();
								}
								else if ($(this).attr('data-upload') == 'false')
								{
									$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look ').hide();
								}
								else
								{
									$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look ').show();
								}
							}
							else if ($(this).parents('.aw-wechat-dropdown-box').find('input.input-code').val().match('http://'))
							{
								$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look ').hide();
							}
						});
					});
					//隐藏父节点的上传图片按钮
					$('.sub_button_' + _i).eq(0).prev().find('.ajax-upload, .ajax-look').hide();
				}
				else
				{
					var _e = e;
					// 插入下拉菜单
					addDropdownList(e.command_type, $('#menu_id_' + _i), false);

					//判断当前是自定义url
					if (e.command_type == '自定义 URL')
					{
						$('#menu_id_' + i).find('.aw-wechat-dropdown-box input.input-code').removeAttr('readonly').val(e.key).show();
						$('#menu_id_' + i).find('.input-bg, span').hide();
					}
					
					// 遍历下拉模板中的li,根据key找中文
					$.each($('#aw-ajax-box ul li'), function (i, e)
					{
						if ($(this).attr('data-value') == _e.key)
						{
							$('#menu_id_' + _i).find('.aw-wechat-dropdown-box span').html($(this).text());
						}
						
					});

					// 给select选中初始化
					$('#menu_id_' + i).find('.aw-wechat-select').val(e.command_type);

					// 判断当前下拉菜单是否有上传图片功能
					if ($('#menu_id_' + _i).find('.aw-wechat-dropdown-box ul').length > 0)
					{
						$.each($('#menu_id_' + _i).find('.aw-wechat-dropdown-box ul li'), function (i, e)
						{
							if ($(this).attr('data-value') == _e.key)
							{
								if ($(this).attr('data-upload') == 'false')
								{
									$('#menu_id_' + _i).find('.ajax-upload, .ajax-look ').hide();
								}
							}
						});
					}
					else
					{
						$('#menu_id_' + _i).find('.ajax-upload, .ajax-look ').hide();
					}
					
				}
			});
		});

		$('#aw-ajax-box').html('');


		// select菜单事件绑定
		$(document).on('change', 'select.aw-wechat-select', function()
		{
			addDropdownList($(this).val(), $(this).parents('tr'), true);
		});
	
		// 点击显示下拉菜单时,将菜单默认选中的选项添加hover状态
		$(document).on('click', '.aw-wechat-dropdown-box input.input-bg', function ()
		{
			$.each($(this).parents('.aw-wechat-dropdown-box').find('.dropdown-menu ul li'), function (i, e)
			{
				if ($(this).attr('data-value') == $(this).parents('.aw-wechat-dropdown-box').find('input.input-code').val())
				{
					$(this).addClass('active');
					if ($(this).index() > 5)
					{
						$(this).parents('ul').scrollTop((parseInt($(this).index() - 5)) * parseInt($(this).css('height')));
					}
				}
			});
		});
		
		// 展开菜单内列表点击事件
		$(document).on('click', '.aw-wechat-dropdown-box .dropdown-menu ul li', function ()
		{
			if ($(this).attr('data-upload') == 'false')
			{
				$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look').hide();
			}
			else
			{
				$(this).parents('.aw-wechat-dropdown-box').find('.ajax-upload, .ajax-look').show();
			}
			$(this).addClass('active');
			$(this).parents('.aw-wechat-dropdown-box').find('li').removeClass('active');
			if (!$(this).attr('data-value').match('http://'))
			{
				$(this).parents('.aw-wechat-dropdown-box').find('span').html($(this).text()).show();
			}
			$(this).parents('.aw-wechat-dropdown-box').find('input.input-code').val($(this).attr('data-value'));
			$(this).parents('.aw-wechat-dropdown-box').find('input.attach_key').val('');
		});
	});

	/* 
	*	插入下拉菜单
	*	type:类型
	*	element:容器
	*	defined_url: 为true时给自定义url输入框添加绑定, false时不做任何处理
	*/
	function addDropdownList (type, element, defined_url)
	{
		switch (type)
		{
			case '最新问题' : 
				var template = $('#drop_menu_template_new_question').html();
			break;
			case '文章专题' :
				var template = $('#drop_menu_template_new_article').html();
			break;
			case '热门问题' :
				var template = $('#drop_menu_template_hot_question').html();
			break;
			case '推荐问题' :
				var template = $('#drop_menu_template_suggest_question').html();
			break;
			case '等待回复' :
				var template = $('#drop_menu_template_wait_replay').html();
			break;
			case '自定义回复' :
				var template = $('#drop_menu_template_auto_replay').html();
			break;
			case '全局命令' :
				var template = $('#drop_menu_template_global').html();
			break;
			case '自定义 URL' :
				var template = $('#drop_menu_template_defined_url').html();
			break;
		}
		
		if (template)
		{
			// 判断是否存在下拉菜单
			if (element.find('.aw-wechat-dropdown-box .dropdown-menu').length > 0)
			{
				element.find('.aw-wechat-dropdown-box .dropdown-menu').detach();
			}
			// 判断上一次选择自定义 URL选项
			if (element.find('.aw-wechat-dropdown-box input.input-code').is(':visible'))
			{
				element.find('.aw-wechat-dropdown-box .fa-sort, .aw-wechat-dropdown-box input.input-bg').show();
				element.find('.aw-wechat-dropdown-box input.input-code').val('').attr('readonly','readonly').hide();
			}
			if (type == '自定义 URL' && defined_url == true)
			{
				element.find('.aw-wechat-dropdown-box span, .aw-wechat-dropdown-box .ajax-upload, .aw-wechat-dropdown-box .ajax-look').hide();
				element.find('.aw-wechat-dropdown-box input.input-bg').hide();
				element.find('.aw-wechat-dropdown-box input.input-code').val('http://').removeAttr('readonly').show();
			}
			element.find('.aw-wechat-dropdown-box').append(template);
		}
	}
	
	function ajax_upload_reload()
	{
		$.each($('.ajax-upload'), function (i, e) {
			init_list_img_uploader(G_BASE_URL + '/admin/weixin/list_image_upload/', 'list_image', $(e));
		});
	}
	
	function init_list_img_uploader(upload_url, upload_name, upload_element, upload_status_elememt, perview_element)
	{
		var attach_key = hex_md5(new Date().getTime() + ' ' + Math.random());
		
	    return new AjaxUpload(upload_element,
	    {
	        action: upload_url + '?attach_access_key='+ attach_key,
	        name: upload_name,
	        responseType: 'json',
	
	        onSubmit: function (file, ext)
	        {
	            if (!new RegExp('(png|jpe|jpg|jpeg|gif)$', 'i').test(ext))
	            {
	                alert(_t('上传失败: 只支持 jpg、gif、png 格式的图片文件'));
	
	                return false;
	            }
	
	            this.disable();
	
	            if (upload_status_elememt)
	            {
	                upload_status_elememt.show();
	            }
	        },
	
	        onComplete: function (file, response)
	        {
	            this.enable();
	
	            if (upload_status_elememt)
	            {
	                upload_status_elememt.hide();
	            }
	
	            if (response.errno == -1)
	            {
	                alert(response.err);
	            }
	            else
	            {
	            	upload_element.prev().val(attach_key);
	            }
	        }
	    });
	}
</script>

<?php TPL::output('admin/global/footer.tpl.htm'); ?>